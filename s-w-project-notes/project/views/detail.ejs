<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/style/detail_style.css">
  <title>ë…¸íŠ¸ ìƒì„¸</title>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <article>
        <h2><%= note.title %></h2>
        <p>ê³¼ëª©ëª…: <%= note.subject %></p>
        <p>êµìˆ˜ëª…: <%= note.professor %></p>
        <p>ì¹´í…Œê³ ë¦¬: <%= note.category %></p>
        <canvas id="pdf-canvas" width="400"></canvas>
        <div><%= note.summary %></div>
        <small>
          ì‘ì„±ì: <%= note.authorName %> /
          ì‘ì„±ì‹œê°„: <%= note.created_at.getFullYear() %>/<%= (note.created_at.getMonth()+1).toString().padStart(2,'0') %>/<%= note.created_at.getDate().toString().padStart(2,'0') %> <%= note.created_at.toLocaleTimeString('ko-KR') %>
        </small>
      </article>

      <% if (user && note.user_id === user.user_id) { %>
        <div>
          <a href="/notes/<%= note.id %>/edit">ìˆ˜ì •</a>
          <form method="POST" action="/notes/<%= note.id %>/delete" style="display:inline;">
            <button type="submit" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
          </form>
        </div>
      <% } %>
  
      <section class="comments">
        <h3>ëŒ“ê¸€</h3>
        <% if (comments.length) { %>
          <ul>
            <% comments.forEach(c => { %>
              <li><strong><%= c.author %>:</strong> <%= c.content %> <em>(<%= c.created_at.toLocaleString() %>)</em></li>
            <% }) %>
          </ul>
        <% } else { %>
          <p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <% } %>

        <% if (user) { %>
          <form method="POST" action="/notes/<%= note.id %>/comments">
            <textarea name="content" placeholder="ëŒ“ê¸€ ì…ë ¥" required></textarea>
            <button type="submit">ëŒ“ê¸€ ì‘ì„±</button>
          </form>
        <% } else { %>
          <p>ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="/login">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
        <% } %>
      </section>
      <a href="/notes">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <div class="right-panel">
      <!-- ë‹¤ìš´ë¡œë“œ ë°•ìŠ¤ -->
      <div class="download-box">
        <h3>ë‹¤ìš´ë¡œë“œ</h3>
        <!-- /files/<%= file.file_name %> -->
        <a id="downloadLink" href="#" download class="download-btn" data-note-id="<%= note.id %>">
          PDF ë‹¤ìš´ë¡œë“œ
        </a>
        <div id="fileInfo" class="file-info">
          íŒŒì¼ëª…: <%= file.file_name %> <br>
          ìš©ëŸ‰: <%= file.file_size %></span> <br>
          ì—…ë¡œë“œ: 
          <%= note.created_at.getFullYear() %>/
          <%= (note.created_at.getMonth() + 1).toString().padStart(2, '0') %>/
          <%= note.created_at.getDate().toString().padStart(2, '0') %>
        </div>
      </div>

      <!-- ì¢‹ì•„ìš” & ë‹¤ìš´ë¡œë“œ ìˆ˜ -->
      <div class="like-download-stats">
      <!-- <% console.log(note); %> -->
        <button id="likeBtn" data-note-id="<%= note.id %>" style="margin-bottom: 10px;">
          ğŸ‘ ì¢‹ì•„ìš” (<span id="likeCount" style="color: aliceblue;"><%= note.like_count %></span>)
        </button>
        <p>ğŸ“¥ ë‹¤ìš´ë¡œë“œ ìˆ˜: <span id="downloadCount"><%= note.download_count || 0 %></span></p>
      </div>
    </div>
  </div>

  <!-- PDF ì‚¬ì§„ ë¡œë“œ ê´€ë ¨ -->
  <script>
    window.pdfUrl = "<%= file.file_path %>";
  </script>
  <script type = "module" src ="/js/pdf_viewer.js"></script>

  <script>
    // PDF ë‹¤ìš´ë¡œë“œ ë²„íŠ¼

    // ì¢‹ì•„ìš” ìˆ˜ ê´€ë ¨
    document.getElementById("likeBtn").addEventListener("click", async function () {
      const noteId = this.dataset.noteId;
      try {
        const res = await fetch(`/notes/${noteId}/like`, { method: 'POST' });
        if (res.status === 401) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }
        if(res.status === 400) {
          alert("ì´ë¯¸ ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤");
        }
        if (res.ok) {
          const countSpan = document.getElementById("likeCount");
          const currentCount = parseInt(countSpan.textContent) || 0;
          countSpan.textContent = currentCount + 1;
        } else {
          const err = await res.json();
          alert(err.message || "ì¢‹ì•„ìš” ì²˜ë¦¬ ì‹¤íŒ¨");
        }
      } catch (e) {
        console.error("ì¢‹ì•„ìš” ì—ëŸ¬:", e);
      }
    });

    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ê´€ë ¨
    document.getElementById("downloadLink").addEventListener("click", async function (e) {
      e.preventDefault();

      const noteId = this.dataset.noteId;
      const stored_name = "<%= file.stored_name %>";

      try {
        // ë‹¤ìš´ë¡œë“œ ê¸°ë¡ + ì¹´ìš´íŠ¸ ì¦ê°€ ì²˜ë¦¬ìš© POST ìš”ì²­ (POST /files/download-log/:noteId)
        const res = await fetch(`/files/download-log/${noteId}`, { method: 'POST' });

        if(res.status === 401) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. (detail.ejs 1)");
          return;
        }

        if(res.status === 404) {
          alert("íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (detail.ejs 2)");
          return;
        }

        if(res.ok) {
          const countSpan = document.getElementById("downloadCount");
          const currentCount = parseInt(countSpan.textContent) || 0;
          countSpan.textContent = currentCount + 1;
          
          // ì‹¤ì œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (GET /files/:stored_name)
          // window.location.href = `/files/${stored_name}`;
          const a = document.createElement('a');
          a.href = `/files/${stored_name}`;
          a.download = '';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }

        else {
          alert("ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬ ì‹¤íŒ¨ (detail.ejs 3)");
        }
      }
      catch(err) {
        console.error("ë‹¤ìš´ë¡œë“œ ì—ëŸ¬:", err);
      }
    });
  </script>
</body>
</html>