<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>노트 상세</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background-color: #f9f9f9; }
    .container { max-width: 800px; margin: auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .note-content { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
    .note-content h1 { margin-top: 0; }
    .comments-section h2 { margin-bottom: 15px; }
    .comment-list { list-style-type: none; padding: 0; }
    .comment-item { background-color: #f9f9f9; border: 1px solid #e0e0e0; padding: 10px 15px; margin-bottom: 10px; border-radius: 5px; }
    .comment-item .author { font-weight: bold; color: #333; }
    .comment-item .date { font-size: 0.8em; color: #777; margin-left: 10px; }
    .comment-item .content { margin-top: 5px; color: #555; }
    .comment-form textarea { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; min-height: 60px; resize: vertical; }
    .comment-form button { padding: 10px 15px; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .comment-form button:hover { background-color: #45a045; }
    .auth-buttons { margin-bottom: 20px; text-align: right; } /* 로그인/로그아웃 버튼용 */
    .auth-buttons button { margin-left: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="auth-buttons">
        <!-- 로그인/로그아웃 버튼 동적 추가 (index.html과 유사하게) -->
    </div>

    <div class="note-content" id="noteDetailContainer">
      <!-- 노트 내용이 여기에 동적으로 로드됩니다. -->
      <h1>노트 제목</h1>
      <p class="meta">작성자: <span id="note-author"></span> | 카테고리: <span id="note-category"></span></p>
      <p id="note-summary">요약 내용...</p>
    </div>

    <div class="comments-section">
      <h2>댓글</h2>
      <ul class="comment-list" id="commentList">
        <!-- 댓글이 여기에 동적으로 로드됩니다. -->
      </ul>
      <form id="commentForm" style="display: none;"> <!-- 로그인 시 보이도록 처리 -->
        <h3>댓글 작성</h3>
        <textarea id="commentContent" placeholder="댓글을 입력하세요..." required></textarea>
        <button type="submit">댓글 등록</button>
      </form>
      <p id="commentLoginPrompt" style="display: none;">댓글을 작성하려면 <a href="/login.html">로그인</a>해주세요.</p>
    </div>
  </div>

  <script>
    // 노트 ID를 URL에서 가져오는 함수 (예: ?id=123)
    function getNoteIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    const noteId = getNoteIdFromUrl();
    const commentList = document.getElementById('commentList');
    const commentForm = document.getElementById('commentForm');
    const commentContentInput = document.getElementById('commentContent');
    const commentLoginPrompt = document.getElementById('commentLoginPrompt');
    const authButtonsContainer = document.querySelector('.auth-buttons'); // 로그인/로그아웃 버튼 컨테이너
    const noteDetailContainer = document.getElementById('noteDetailContainer'); // 노트 상세 내용 컨테이너

    let currentUser = null; // 로그인한 사용자 정보 저장 (userId, username 포함)

    // 로그인 상태 확인 및 UI 업데이트
    function checkLoginStatus() {
        console.log('note_detail.html: Checking login status...'); // 디버깅 로그
        fetch('/check-login') // controller.js의 API 호출
            .then(res => {
                if (!res.ok) {
                    // 서버에서 4xx, 5xx 응답을 보내면 에러로 처리
                    return res.json().then(errData => { throw new Error(errData.message || `HTTP error! status: ${res.status}`) });
                }
                return res.json();
            })
            .then(data => {
                console.log('note_detail.html: /check-login response data:', data); // 응답 데이터 로그

                authButtonsContainer.innerHTML = ''; // 기존 버튼 초기화

                if (data.loggedIn && data.username) { // controller.js에서 username을 보내준다고 가정
                    console.log('note_detail.html: User is logged in.');
                    currentUser = { userId: data.userId, username: data.username }; // 필요한 정보만 저장

                    const welcomeText = document.createElement('span');
                    welcomeText.textContent = `환영합니다, ${data.username}님!`;
                    welcomeText.style.marginRight = '10px';
                    welcomeText.style.fontWeight = 'bold';

                    const logoutButton = document.createElement('button');
                    logoutButton.textContent = '로그아웃';
                    logoutButton.onclick = () => location.href = '/logout';

                    authButtonsContainer.appendChild(welcomeText);
                    authButtonsContainer.appendChild(logoutButton);

                    commentForm.style.display = 'block'; // 로그인 시 댓글 폼 보이기
                    commentLoginPrompt.style.display = 'none';
                } else {
                    console.log('note_detail.html: User is NOT logged in.');
                    currentUser = null;

                    const signupButton = document.createElement('button');
                    signupButton.textContent = '회원가입';
                    signupButton.onclick = () => location.href = '/signup.html'; // signup.html 경로

                    const loginButton = document.createElement('button');
                    loginButton.textContent = '로그인';
                    loginButton.onclick = () => location.href = '/login.html'; // login.html 경로

                    authButtonsContainer.appendChild(signupButton);
                    authButtonsContainer.appendChild(loginButton);

                    commentForm.style.display = 'none'; // 비로그인 시 댓글 폼 숨기기
                    commentLoginPrompt.style.display = 'block';
                }
            })
            .catch(err => {
                console.error('note_detail.html: 로그인 상태 확인 실패:', err);
                authButtonsContainer.innerHTML = `<span style="color:red;">로그인 상태 확인 중 오류: ${err.message}</span>`;
                // 로그인 상태 확인 실패 시에도 댓글 폼 및 프롬프트 처리
                commentForm.style.display = 'none';
                commentLoginPrompt.style.display = 'block'; // 로그인하라는 메시지 표시
            });
    }


    // 노트 상세 정보 로드 함수
    async function loadNoteDetail() {
      if (!noteId) {
        if(noteDetailContainer) noteDetailContainer.innerHTML = '<p>잘못된 접근입니다. 노트 ID가 없습니다.</p>';
        return;
      }
      console.log(`note_detail.html: Loading note detail for ID: ${noteId}`);
      try {
        const response = await fetch(`/api/notes/${noteId}`); // controller.js의 API 호출
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: '노트 정보를 불러오는데 실패했습니다 (상세 오류 없음).' })); // JSON 파싱 실패 대비
            throw new Error(errorData.message || `노트 정보를 불러오는데 실패했습니다: ${response.statusText}`);
        }
        const note = await response.json();

        if(noteDetailContainer) {
            document.querySelector('.note-content h1').textContent = note.subject || '제목 없음';
            document.getElementById('note-author').textContent = note.authorName || '정보 없음';
            document.getElementById('note-category').textContent = note.category || '정보 없음';
            document.getElementById('note-summary').textContent = note.summary || '내용 없음';
        }
      } catch (error) {
        console.error('note_detail.html: Error loading note detail:', error);
        if(noteDetailContainer) noteDetailContainer.innerHTML = `<p>노트 내용을 불러오는 중 오류: ${error.message}</p>`;
      }
    }


    // 댓글 목록 로드 및 표시 함수
    async function loadComments() {
      if (!noteId) return;
      console.log(`note_detail.html: Loading comments for note ID: ${noteId}`);
      try {
        const response = await fetch(`/api/notes/${noteId}/comments`); // controller.js의 API 호출
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: '댓글을 불러오는데 실패했습니다 (상세 오류 없음).' }));
            throw new Error(errorData.message || `댓글을 불러오는데 실패했습니다: ${response.statusText}`);
        }
        const comments = await response.json();
        
        commentList.innerHTML = ''; // 기존 목록 초기화
        if (comments.length === 0) {
            commentList.innerHTML = '<li>아직 댓글이 없습니다.</li>';
        } else {
            comments.forEach(comment => {
              addCommentToDOM(comment);
            });
        }
      } catch (error) {
        console.error('note_detail.html: Error loading comments:', error);
        commentList.innerHTML = `<li>댓글을 불러오는 중 오류: ${error.message}</li>`;
      }
    }

    // 단일 댓글을 DOM에 추가하는 함수
    function addCommentToDOM(comment) {
        const listItem = document.createElement('li');
        listItem.className = 'comment-item';
        listItem.setAttribute('data-comment-id', comment.id);

        const authorSpan = document.createElement('span');
        authorSpan.className = 'author';
        authorSpan.textContent = comment.author || '익명'; // API에서 author (username)를 반환해야 함

        const dateSpan = document.createElement('span');
        dateSpan.className = 'date';
        // 날짜 형식이 유효한지 확인 후 변환
        try {
            dateSpan.textContent = new Date(comment.created_at).toLocaleString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        } catch (e) {
            dateSpan.textContent = comment.created_at; // 변환 실패 시 원본 표시
        }


        const contentP = document.createElement('p');
        contentP.className = 'content';
        // XSS 방지를 위해 textContent 사용 (이미 사용 중)
        contentP.textContent = comment.content;

        listItem.appendChild(authorSpan);
        listItem.appendChild(dateSpan);
        listItem.appendChild(contentP);

        // 만약 "아직 댓글이 없습니다." 메시지가 있었다면 제거
        const noCommentLi = commentList.querySelector('li');
        if (noCommentLi && noCommentLi.textContent === '아직 댓글이 없습니다.') {
            commentList.innerHTML = '';
        }
        commentList.appendChild(listItem);
    }


    // 댓글 작성 처리
    commentForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!currentUser || !currentUser.userId) { // currentUser와 currentUser.userId 존재 여부 확인
          alert('댓글을 작성하려면 로그인이 필요합니다.');
          window.location.href = '/login.html'; // 로그인 페이지로 이동
          return;
      }

      const content = commentContentInput.value.trim();
      if (!content) {
        alert('댓글 내용을 입력해주세요.');
        return;
      }
      console.log(`note_detail.html: Posting comment by user ID: ${currentUser.userId}`);
      try {
        const response = await fetch(`/api/notes/${noteId}/comments`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // CSRF 토큰이 필요하다면 여기에 추가
          },
          body: JSON.stringify({ content: content }), // 'content' 키로 전송
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ message: '댓글 작성에 실패했습니다 (상세 오류 없음).' }));
          throw new Error(errorData.message || `댓글 작성에 실패했습니다: ${response.statusText}`);
        }
        
        const newComment = await response.json();
        console.log('note_detail.html: New comment posted:', newComment);
        addCommentToDOM(newComment); // 새로 추가된 댓글을 목록에 바로 표시
        commentContentInput.value = ''; // 입력 필드 초기화

      } catch (error) {
        console.error('note_detail.html: Error posting comment:', error);
        alert(`댓글 작성 오류: ${error.message}`);
      }
    });

    // 페이지 로드 시 실행
    window.addEventListener('DOMContentLoaded', () => {
      console.log('note_detail.html: DOM Content Loaded. Initializing page...');
      checkLoginStatus(); // 로그인 상태 먼저 확인
      loadNoteDetail();   // 노트 내용 로드
      loadComments();     // 댓글 목록 로드
    });
  </script>
</body>
</html>