<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/style/detail_style.css">
  <title>ë…¸íŠ¸ ìƒì„¸</title>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <article>
        <h2><%= note.title %></h2>
        <p>ê³¼ëª©ëª…: <%= note.subject %></p>
        <p>êµìˆ˜ëª…: <%= note.professor %></p>
        <p>ì¹´í…Œê³ ë¦¬: <%= note.category %></p>
        <canvas id="pdf-canvas" width="400"></canvas>
        <div><%= note.summary %></div>
        <small>
          ì‘ì„±ì: <%= note.authorName %> /
          ì‘ì„±ì‹œê°„: <%= note.created_at.getFullYear() %>/<%= (note.created_at.getMonth()+1).toString().padStart(2,'0') %>/<%= note.created_at.getDate().toString().padStart(2,'0') %> <%= note.created_at.toLocaleTimeString('ko-KR') %>
        </small>
      </article>

      <% if (user && note.user_id === user.user_id) { %>
        <div>
          <a href="/notes/<%= note.id %>/edit">ìˆ˜ì •</a>
          <form method="POST" action="/notes/<%= note.id %>/delete" style="display:inline;">
            <input type="hidden" name="_method" value="DELETE">
            <button type="submit" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
          </form>
        </div>
      <% } %>

  <% 
  // comments ë°°ì—´ì„ parent_id ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬
    const parents = comments.filter(c => c.parent_id === null);
    const childrenByParent = {}; 
    comments.forEach(c => {
      if (c.parent_id) {
        if (!childrenByParent[c.parent_id]) childrenByParent[c.parent_id] = [];
        childrenByParent[c.parent_id].push(c);
      }
    });
  %>

  <section class="comments">
    <h3>ëŒ“ê¸€ (<%= parents.length %>)</h3>

    <% if (parents.length > 0) { %>
      <ul class="comments-list">
        <% parents.forEach(parent => { %>
          <li id="comment-<%= parent.id %>" class="comment-item" style="margin-bottom: 1.5rem;">

            <!-- 1) ë¶€ëª¨ ëŒ“ê¸€ ìˆ˜ì • ë¶„ê¸° -->
            <% if (editCommentId === parent.id) { %>
              <!-- ìˆ˜ì • í¼ (ì¸ë¼ì¸ìœ¼ë¡œ í…ìŠ¤íŠ¸ë°•ìŠ¤ ë³´ì„) -->
              <form
                id="edit-parent-form-<%= parent.id %>"
                action="/notes/<%= note.id %>/comments/<%= parent.id %>"
                method="POST"
              >
                <input type="hidden" name="_method" value="PUT">
                <!-- ìˆ˜ì •ìš© textareaì—ë„ js-enter-submit í´ë˜ìŠ¤ì™€ data-form-id ì§€ì • -->
                <textarea
                  name="content"
                  rows="3"
                  required
                  class="js-enter-submit"
                  data-form-id="edit-parent-form-<%= parent.id %>"
                ><%= parent.content %></textarea>
                <button type="submit">ì €ì¥</button>
                <a href="/notes/<%= note.id %>">ì·¨ì†Œ</a>
              </form>
            <% } else { %>
              <!-- ìˆ˜ì • í¼ì´ ì•„ë‹ ë•Œ(ì¼ë°˜ ëŒ“ê¸€ í‘œì‹œ) -->
              <div class="comment-main">
                <p><strong><%= parent.author %>:</strong> <%= parent.content %></p>
                <small><em><%= new Date(parent.created_at).toLocaleString('ko-KR') %></em></small>
                <% if (user && user.user_id === parent.user_id) { %>
                  <span class="comment-actions">
                    <!-- ìˆ˜ì • ë²„íŠ¼: í´ë¦­ ì‹œ í˜ì´ì§€ê°€ ?editCommentId=<id>ë¡œ ë¦¬ë¡œë“œë¨ -->
                    <a href="/notes/<%= note.id %>?editCommentId=<%= parent.id %>#comment-<%= parent.id %>">ìˆ˜ì •</a>
                    <form action="/notes/<%= note.id %>/comments/<%= parent.id %>" method="POST" style="display:inline;">
                      <input type="hidden" name="_method" value="DELETE">
                      <button onclick="return confirm('ëŒ“ê¸€ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
                    </form>
                  </span>
                <% } %>
                <% if (user) { %>
                  <button class="reply-toggle-btn" data-parent-id="<%= parent.id %>">ë‹µê¸€ ì“°ê¸°</button>
                <% } %>
              </div>
            <% } %>

            <!-- 2) ëŒ€ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ -->
            <% if (childrenByParent[parent.id]) { %>
              <ul class="nested-comments-list" style="margin-left: 2rem; margin-top: 1rem;">
                <% childrenByParent[parent.id].forEach(child => { %>
                  <li id="comment-<%= child.id %>" class="comment-item child-comment" style="margin-bottom: 1rem;">

                    <!-- ëŒ€ëŒ“ê¸€ ìˆ˜ì • ë¶„ê¸° -->
                    <% if (editCommentId === child.id) { %>
                      <form
                        id="edit-child-form-<%= child.id %>"
                        action="/notes/<%= note.id %>/comments/<%= child.id %>"
                        method="POST"
                      >
                        <input type="hidden" name="_method" value="PUT">
                        <!-- ìˆ˜ì •ìš© textareaì—ë„ ë™ì¼í•˜ê²Œ ì²˜ë¦¬ -->
                        <textarea
                          name="content"
                          rows="2"
                          required
                          class="js-enter-submit"
                          data-form-id="edit-child-form-<%= child.id %>"
                        ><%= child.content %></textarea>
                        <button type="submit">ì €ì¥</button>
                        <a href="/notes/<%= note.id %>">ì·¨ì†Œ</a>
                      </form>
                    <% } else { %>
                      <p><strong><%= child.author %>:</strong> <%= child.content %></p>
                      <small><em><%= new Date(child.created_at).toLocaleString('ko-KR') %></em></small>
                      <% if (user && user.user_id === child.user_id) { %>
                        <span class="comment-actions">
                          <a href="/notes/<%= note.id %>?editCommentId=<%= child.id %>#comment-<%= child.id %>">ìˆ˜ì •</a>
                          <form action="/notes/<%= note.id %>/comments/<%= child.id %>" method="POST" style="display:inline;">
                            <input type="hidden" name="_method" value="DELETE">
                            <button onclick="return confirm('ëŒ“ê¸€ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
                          </form>
                        </span>
                      <% } %>
                    <% } %>

                  </li>
                <% }) %>
              </ul>
            <% } %>

            <!-- 3) ëŒ€ëŒ“ê¸€ ì‘ì„± í¼(ìˆ¨ê¹€) -->
            <% if (user) { %>
              <form
                id="reply-form-<%= parent.id %>"
                action="/notes/<%= note.id %>/comments"
                method="POST"
                class="new-reply-form"
                style="display: none; margin-left: 2rem; margin-top: 0.5rem;"
              >
                <input type="hidden" name="parentId" value="<%= parent.id %>">
                <!-- textareaì— ë™ì¼í•œ í´ë˜ìŠ¤ì™€ data-form-idë¥¼ ì„¤ì • -->
                <textarea
                  name="content"
                  rows="2"
                  placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"
                  required
                  class="js-enter-submit"
                  data-form-id="reply-form-<%= parent.id %>"
                ></textarea>
                <button type="submit">ë“±ë¡</button>
                <button type="button" class="cancel-reply-btn" data-parent-id="<%= parent.id %>">ì·¨ì†Œ</button>
              </form>
            <% } %>

          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    <% } %>

    <!-- ìµœìƒìœ„ ëŒ“ê¸€ ì‘ì„± í¼ì€ ê·¸ëŒ€ë¡œ ë‘ë©´ ë©ë‹ˆë‹¤ -->
    <% if (user) { %>
      <form id="new-comment-form" action="/notes/<%= note.id %>/comments" method="POST" class="new-comment-form" style="margin-top: 2rem;">
        <h4>ìƒˆ ëŒ“ê¸€ ì‘ì„±</h4>
        <!-- textareaì— í´ë˜ìŠ¤ ë° data-form-id ì§€ì • -->
        <textarea
          name="content"
          rows="3"
          placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"
          required
          class="js-enter-submit"
          data-form-id="new-comment-form"
        ></textarea>
        <button type="submit">ë“±ë¡</button>
      </form>
    <% } else { %>
      <p>ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="/auth/login">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
    <% } %>

  </section>
 
      <a href="/">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <div class="right-panel">
      <!-- ë‹¤ìš´ë¡œë“œ ë°•ìŠ¤ -->
      <div class="download-box">
        <h3>ë‹¤ìš´ë¡œë“œ</h3>
          <a id="downloadLink" href="#" class="download-btn" data-note-id="<%= note.id %>" data-filename = "<%= file.stored_name %>">
            PDF ë‹¤ìš´ë¡œë“œ
          </a>
        <div id="fileInfo" class="file-info">
          íŒŒì¼ëª…: <%= file.file_name %> <br>
          ìš©ëŸ‰: <%= file.file_size %></span> <br>
          ì—…ë¡œë“œ: 
          <%= note.created_at.getFullYear() %>/
          <%= (note.created_at.getMonth() + 1).toString().padStart(2, '0') %>/
          <%= note.created_at.getDate().toString().padStart(2, '0') %>
        </div>
      </div>

      <!-- ì¢‹ì•„ìš” & ë‹¤ìš´ë¡œë“œ ìˆ˜ -->
      <div class="like-download-stats">
      <!-- <% console.log(note); %> -->
        <button id="likeBtn" data-note-id="<%= note.id %>" style="margin-bottom: 10px;">
          ğŸ‘ ì¢‹ì•„ìš” (<span id="likeCount" style="color: aliceblue;"><%= note.like_count %></span>)
        </button>
        <p>ğŸ“¥ ë‹¤ìš´ë¡œë“œ ìˆ˜: <span id="downloadCount"><%= note.download_count || 0 %></span></p>
      </div>
    </div>
  </div>

  <!-- PDF ì‚¬ì§„ ë¡œë“œ ê´€ë ¨ -->
  <script>
    window.pdfUrl = "<%= file.file_path %>";
  </script>
  <script type = "module" src ="/js/pdf_viewer.js"></script>

  <script>
    // ì¢‹ì•„ìš” ì¹´ìš´íŒ…
    document.getElementById("likeBtn").addEventListener("click", async function () {
      const noteId = this.dataset.noteId;

      try {
        const res = await fetch(`/notes/${noteId}/like`, { method: 'POST' });
        const result = await res.json();

        if(res.status === 401) {
          alert(result.message);
          return;
        }

        if (res.status === 200) { // ì¢‹ì•„ìš” ì²˜ë¦¬ ì™„ë£Œ
          const countSpan = document.getElementById("likeCount");
          countSpan.textContent = parseInt(countSpan.textContent) + 1;
          alert(result.message);
        }

        else {
          alert(result.message);
        }

      } catch (e) {
        console.error("ì¢‹ì•„ìš” ì—ëŸ¬:", e);
        alert("ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  </script>

  <script>
    // ë‹µê¸€ ì“°ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ëŒ€ì‘í•˜ëŠ” hidden formì„ ë³´ì´ë„ë¡/ìˆ¨ê¸°ë„ë¡
    document.querySelectorAll('.reply-toggle-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const parentId = btn.dataset.parentId;
        const form = document.getElementById(`reply-form-${parentId}`);
        form.style.display = (form.style.display === 'none' || !form.style.display) ? 'block' : 'none';
      });
    });

    // ë‹µê¸€ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ í¼ì„ ìˆ¨ê¹€
    document.querySelectorAll('.cancel-reply-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const parentId = btn.dataset.parentId;
        const form = document.getElementById(`reply-form-${parentId}`);
        form.style.display = 'none';
      });
    });
  </script>

  <script>
    // ë‹¤ìš´ë¡œë“œ ì¹´ìš´íŒ… & íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("downloadLink").addEventListener("click", async function(e) {
        e.preventDefault();

        const noteId = this.dataset.noteId;
        const stored_name = this.dataset.filename;

        try {
          const updateDownload_log_res = await fetch(`/files/download-log/${noteId}`, { method: 'POST' });
          const updateDownload_log_result = await updateDownload_log_res.json();

          if(updateDownload_log_res.status === 401 || updateDownload_log_res.status === 404 || !updateDownload_log_res.ok) {
            alert(updateDownload_log_result.message);
            return;
          }

          alert(updateDownload_log_result.message);

          const link = document.createElement('a');
          link.href = `/files/download/${stored_name}`; // downloadController => /files/download/:stored_nameìœ¼ë¡œ GET ìš”ì²­
          link.download = '';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        
          // ë‹¤ìš´ë¡œë“œ ì¹´ìš´íŒ… +1 ì˜¬ë¦¬ê¸°
          const countSpan = document.getElementById("downloadCount");
          const currentCount = parseInt(countSpan.textContent) || 0;
          countSpan.textContent = currentCount + 1;
        
        } catch(e) {
          console.log(e);
          alert("ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜");
        }
      });
    });
  </script>
</body>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // .js-enter-submit í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ëª¨ë“  textareaì— keydown ì´ë²¤íŠ¸ë¥¼ ë‹¬ì•„ì¤ë‹ˆë‹¤.
      document.querySelectorAll('.js-enter-submit').forEach(textarea => {
        textarea.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            // Ctrl+EnterëŠ” ì¤„ë°”ê¿ˆ(ê¸°ë³¸ ë™ì‘) ê·¸ëŒ€ë¡œ
            if (e.ctrlKey) {
              return;
            }
            // Enter ë‹¨ë…: ê¸°ë³¸ ì¤„ë°”ê¿ˆ ë°©ì§€ í›„ í•´ë‹¹ í¼ ì œì¶œ
            e.preventDefault();
            const formId = textarea.dataset.formId;
            const form = document.getElementById(formId);
            if (form) form.submit();
          }
        });
      });
    });
  </script>

<% if(typeof(alertMessage) != 'undefined') { %>
  <script>
    alert("<%= alertMessage.replace(/\n/g, '\\n') %>");
  </script>
<% } %>

</html>