<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/style/detail_style.css">
  <title>ë…¸íŠ¸ ìƒì„¸</title>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <article>
        <h2><%= note.title %></h2>
        <p>ê³¼ëª©ëª…: <%= note.subject %></p>
        <p>êµìˆ˜ëª…: <%= note.professor %></p>
        <p>ì¹´í…Œê³ ë¦¬: <%= note.category %></p>
        <canvas id="pdf-canvas" width="400"></canvas>
        <div><%= note.summary %></div>
        <small>
          ì‘ì„±ì: <%= note.authorName %> /
          ì‘ì„±ì‹œê°„: <%= note.created_at.getFullYear() %>/<%= (note.created_at.getMonth()+1).toString().padStart(2,'0') %>/<%= note.created_at.getDate().toString().padStart(2,'0') %> <%= note.created_at.toLocaleTimeString('ko-KR') %>
        </small>
      </article>

      <% if (user && note.user_id === user.user_id) { %>
        <div>
          <a href="/notes/<%= note.id %>/edit">ìˆ˜ì •</a>
          <form method="POST" action="/notes/<%= note.id %>/delete" style="display:inline;">
            <button type="submit" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
          </form>
        </div>
      <% } %>
  
  <section class="comments">
      <h3>ëŒ“ê¸€ (<%= comments ? comments.length : 0 %>)</h3>

      <% if (comments && comments.length > 0) { %>
        <ul class="comments-list">
          <% comments.forEach(c => { %>
            <li class="comment-item">
              <% if (editCommentId === c.id) { %>
                <!-- ì¸ë¼ì¸ ëŒ“ê¸€ ìˆ˜ì • í¼ -->
                 <!-- â˜… EDITED at 2025-05-23 -->
                  <form action="/notes/<%= note.id %>/comments/<%= c.id %>" method="POST">
                    <!-- method-overrideë¥¼ bodyì—ì„œ ì½ë„ë¡ hidden í•„ë“œ ì¶”ê°€ -->
                    <input type="hidden" name="_method" value="PUT">
                    <textarea name="content" rows="3" required><%= c.content %></textarea>
                    <button type="submit">ì €ì¥</button>
                    <a href="/notes/<%= note.id %>">ì·¨ì†Œ</a>
                  </form>
              <% } else { %>
                <!-- ì¼ë°˜ ëŒ“ê¸€ í‘œì‹œ -->
                <p><strong><%= c.author %>:</strong> <%= c.content %></p>
                <small>
                  <em><%= new Date(c.created_at).toLocaleString('ko-KR') %></em>
                </small>

                <% /* ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼: ë¡œê·¸ì¸ & ì‘ì„±ì ë³¸ì¸ë§Œ */ %>
                <% if (user && user.user_id === c.user_id) { %>
                  <span class="comment-actions">
                    <a
                      href="/notes/<%= note.id %>?editCommentId=<%= c.id %>"
                    >ìˆ˜ì •</a>
                     <form action="/notes/<%= note.id %>/comments/<%= c.id %>" method="POST" style="display:inline">
                        <!-- ì—¬ê¸°ì—ë„ hidden í•„ë“œë¡œ DELETE ì§€ì • -->
                        <input type="hidden" name="_method" value="DELETE">
                        <button onclick="return confirm('ëŒ“ê¸€ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
                     </form>
                  </span>
                <% } %>
              <% } %>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      <% } %>

      <% /* ìƒˆ ëŒ“ê¸€ ì‘ì„± í¼ */ %>
      <% if (user) { %>
        <form action="/notes/<%= note.id %>/comments" method="POST" class="new-comment-form">
          <h4>ìƒˆ ëŒ“ê¸€ ì‘ì„±</h4>
          <textarea
            name="content"
            rows="3"
            placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"
            required
          ></textarea>
          <button type="submit">ë“±ë¡</button>
        </form>
      <% } else { %>
        <p>
          ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´
          <a href="/login">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.
        </p>
      <% } %>
    </section>

      <a href="/notes">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>


    <div class="right-panel">
      <!-- ë‹¤ìš´ë¡œë“œ ë°•ìŠ¤ -->
      <div class="download-box">
        <h3>ë‹¤ìš´ë¡œë“œ</h3>
        <a id="downloadLink" href="/notes/<%= note.id %>/download" class="download-btn">
          PDF ë‹¤ìš´ë¡œë“œ
        </a>
        <div id="fileInfo" class="file-info">
          íŒŒì¼ëª…: <%= file.file_name %> <br>
          ìš©ëŸ‰: <%= file.file_size %></span> <br>
          ì—…ë¡œë“œ: 
          <%= note.created_at.getFullYear() %>/
          <%= (note.created_at.getMonth() + 1).toString().padStart(2, '0') %>/
          <%= note.created_at.getDate().toString().padStart(2, '0') %>
        </div>
      </div>

      <!-- ì¢‹ì•„ìš” & ë‹¤ìš´ë¡œë“œ ìˆ˜ -->
      <div class="like-download-stats">
      <!-- <% console.log(note); %> -->
        <button id="likeBtn" data-note-id="<%= note.id %>" style="margin-bottom: 10px;">
          ğŸ‘ ì¢‹ì•„ìš” (<span id="likeCount" style="color: aliceblue;"><%= note.like_count %></span>)
        </button>
        <p>ğŸ“¥ ë‹¤ìš´ë¡œë“œ ìˆ˜: <span id="downloadCount"><%= note.download_count || 0 %></span></p>
      </div>
    </div>
  </div>

  <!-- PDF ì‚¬ì§„ ë¡œë“œ ê´€ë ¨ -->
  <script>
    window.pdfUrl = "<%= file.file_path %>";
  </script>
  <script type = "module" src ="/js/pdf_viewer.js"></script>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  const likeBtn = document.getElementById("likeBtn");
  if (!likeBtn) return;

  likeBtn.replaceWith(likeBtn.cloneNode(true));
  const newBtn = document.getElementById("likeBtn");

  newBtn.addEventListener("click", async function (e) {
    e.preventDefault();
    const noteId = this.dataset.noteId;

    try {
      const res = await fetch(`/notes/${noteId}/like`, { method: 'POST' });

      if (res.status === 401) {
        return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      }

      if (res.status === 400) {
        const result = await res.json();
        return alert(result.message || "ì´ë¯¸ ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤.");
      }

      if (!res.ok) {
        return alert("ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
      }

      // âœ… ì •ìƒ ì²˜ë¦¬ëœ ê²½ìš°
      const countSpan = document.getElementById("likeCount");
      countSpan.textContent = parseInt(countSpan.textContent) + 1;

    } catch (err) {
      console.error("ì¢‹ì•„ìš” ì—ëŸ¬:", err);
      alert("ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    }
  });
});

    // PDF ë‹¤ìš´ë¡œë“œ ê´€ë ¨ (í•´ì•¼í•¨)
    // ë‹¤ìš´ë¡œë“œ ìˆ˜ ìˆ˜ì •
    document.getElementById("downloadLink");
  </script>
  <script>
    document.getElementById("likeBtn").addEventListener("click", async function () {
      const noteId = this.dataset.noteId;
      try {
        const res = await fetch(`/notes/${noteId}/like`, { method: 'POST' });
        const result = await res.json();

        if (!res.ok) {
          // 401, 400, ê·¸ ì™¸ ëª¨ë‘ í•œ ê³³ì—ì„œ ì²˜ë¦¬
          return alert(result.message);
        }

        // ì„±ê³µí–ˆì„ ë•Œ
        const countSpan = document.getElementById("likeCount");
        countSpan.textContent = parseInt(countSpan.textContent) + 1;
      } catch (e) {
        console.error("ì¢‹ì•„ìš” ì—ëŸ¬:", e);
        alert("ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  </script>
</body>
</html>